// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum NotificationType {
  NEW_CUSTOMER
  NEW_PROFESSIONAL_CERTIFICATION
  ORDER
  ORDER_STATUS
  ORDER_SHIPPED
  ORDER_DELIVERED
  SYSTEM
  SALON_REJECTED
  SALON_APPROVED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  password        String
  name            String?
  image           String?
  role            UserRole       @default(USER)
  permissions     Json? // Store permissions as JSON: { "addProduct": "allow", "updateProduct": "deny", ... }
  isActive        Boolean        @default(true)
  lastLoginAt     DateTime?
  certificationId String?
  certification   Certification? @relation(fields: [certificationId], references: [id], onDelete: SetNull)
  certificateUrl  String?
  shippingAddress String?
  pointsBalance   Int            @default(0) // Cached points balance for performance
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  cart               Cart?
  orders             Order[]
  chatMessages       ChatMessage[]
  salon              Salon?
  comments           Comment[]
  productReviews     ProductReview[]
  notifications      Notification[]
  affiliate          Affiliate?
  pointsTransactions PointsTransaction[]
  pointsRedemptions  PointsRedemption[]
  affiliateReferral  AffiliateReferral?  @relation("ReferredUser")
  adminLogs          AdminLog[]          @relation("AdminLogs")

  @@index([certificationId])
}

model Category {
  id            String     @id @default(cuid())
  name          String
  slug          String     @unique
  description   String?
  image         String?
  icon          String?
  parentId      String? // For subcategories - references parent category
  parent        Category?  @relation("CategorySubcategories", fields: [parentId], references: [id], onDelete: Cascade)
  subcategories Category[] @relation("CategorySubcategories")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  products                Product[]
  productSubcategories    ProductSubcategory[]
  certificationCategories CertificationCategory[]

  @@index([parentId])
}

model Product {
  id                 String    @id @default(cuid())
  name               String
  description        String?
  price              Decimal   @db.Decimal(10, 2)
  salePrice          Decimal?  @db.Decimal(10, 2) // Sale/discounted price
  discountPercentage Int? // Discount percentage (0-100)
  image              String?
  images             String[]  @default([])
  featured           Boolean   @default(false)
  categoryId         String?
  category           Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  attributes         Json? // Store product attributes as JSON: { "size": ["S", "M", "L"], "color": ["Red", "Blue"] }
  showcasingSections String[]  @default([]) // Showcasing sections: treatment-gels, color-gels, evo-color-gels, top-coats, hand-care, foot-care, reds, pinks, nudes, oranges
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  subcategories ProductSubcategory[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       ProductReview[]
}

model ProductSubcategory {
  id         String   @id @default(cuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
}

model Order {
  id                  String             @id @default(cuid())
  userId              String
  user                User               @relation(fields: [userId], references: [id])
  total               Decimal            @db.Decimal(10, 2)
  status              OrderStatus        @default(PENDING)
  paymentIntentId     String?            @unique
  shippingAddress     String?
  affiliateReferralId String? // If purchased via referral link
  affiliateReferral   AffiliateReferral? @relation(fields: [affiliateReferralId], references: [id], onDelete: SetNull)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  items OrderItem[]

  @@index([affiliateReferralId])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@unique([orderId, productId])
}

model Attribute {
  id        String   @id @default(cuid())
  category  String
  values    String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  permissions Json? // Store permissions as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum GalleryItemType {
  FILE
  FOLDER
}

model GalleryItem {
  id          String          @id @default(cuid())
  name        String
  type        GalleryItemType
  url         String? // For files, this is the file URL
  mimeType    String? // For files, e.g., "image/jpeg", "application/pdf"
  size        Int? // File size in bytes
  folderId    String? // Parent folder ID
  folder      GalleryItem?    @relation("FolderItems", fields: [folderId], references: [id], onDelete: Cascade)
  items       GalleryItem[]   @relation("FolderItems")
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([folderId])
}

model Salon {
  id              String      @id @default(cuid())
  name            String
  address         String
  city            String
  postalCode      String?
  phone           String?
  email           String?
  website         String?
  latitude        Float?
  longitude       Float?
  image           String?     @db.Text
  logo            String?     @db.Text
  images          String[]    @default([])
  description     String?     @db.Text
  workingHours    Json? // Store working hours as JSON: { "monday": { "open": "09:00", "close": "18:00", "closed": false }, ... }
  isActive        Boolean     @default(true)
  isBioDiamond    Boolean     @default(false)
  status          SalonStatus @default(APPROVED) // For admin-created salons, default to APPROVED. For client-created, set to PENDING_REVIEW
  rejectionReason String?     @db.Text // Reason for rejection if status is REJECTED
  reviewedBy      String? // User ID of admin who reviewed
  reviewedAt      DateTime? // When the salon was reviewed
  userId          String?     @unique // Link salon to user (one salon per user)
  user            User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([city])
  @@index([isActive])
  @@index([isBioDiamond])
  @@index([userId])
  @@index([status])
}

model Notification {
  id           String           @id @default(cuid())
  type         NotificationType
  title        String
  message      String
  image        String?          @db.Text // Base64 encoded image for notifications
  read         Boolean          @default(false)
  userId       String? // Link to specific user (null = admin notification or broadcast to all)
  user         User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkUrl      String? // Optional link URL for notifications
  scheduledFor DateTime? // Optional scheduled date/time for sending
  isScheduled  Boolean          @default(false) // Whether this notification is scheduled
  metadata     Json? // Store additional data like customer ID, order ID, etc.
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([read])
  @@index([createdAt])
  @@index([userId])
  @@index([scheduledFor])
  @@index([isScheduled])
}

model ChatMessage {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  message       String
  adminResponse String?
  readByAdmin   Boolean   @default(false)
  readAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([readByAdmin])
  @@index([createdAt])
}

enum BlogStatus {
  DRAFT
  PUBLISHED
}

model Blog {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  excerpt     String?
  content     String     @db.Text
  image       String?
  author      String?
  status      BlogStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  comments Comment[]

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

model Comment {
  id         String       @id @default(cuid())
  blogId     String
  blog       Blog         @relation(fields: [blogId], references: [id], onDelete: Cascade)
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  content    String       @db.Text
  status     ReviewStatus @default(PENDING)
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([blogId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
}

model ProductReview {
  id              String       @id @default(cuid())
  productId       String
  product         Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating          Int          // 1-5
  title           String?
  content         String       @db.Text
  verifiedBuyer   Boolean      @default(false)
  helpfulCount    Int          @default(0)
  notHelpfulCount Int          @default(0)
  status          ReviewStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  companyResponse String?      @db.Text
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([productId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([rating])
}

enum SocialMediaPlatform {
  INSTAGRAM
  FACEBOOK
  TWITTER
  LINKEDIN
  TIKTOK
}

enum SocialMediaPostStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
}

enum SalonStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ContentType {
  POST
  STORY
  REELS
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum CouponSource {
  MANUAL
  REDEMPTION
}

enum ReferralStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum PointsTransactionType {
  AFFILIATE_REFERRAL
  AFFILIATE_PURCHASE
  REDEMPTION
  MANUAL_ADJUSTMENT
}

enum PointsConfigurationActionType {
  REFERRAL_SIGNUP
  REFERRAL_FIRST_ORDER
  REFERRAL_REPEAT_ORDER
  OWN_PURCHASE
}

enum RedemptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  USED
}

enum AffiliateTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model SocialMediaPost {
  id                 String                @id @default(cuid())
  platform           SocialMediaPlatform   @default(INSTAGRAM)
  contentType        ContentType           @default(POST)
  caption            String                @db.Text
  images             String[]              @default([])
  scheduledDate      DateTime
  status             SocialMediaPostStatus @default(DRAFT)
  reviewComments     String?               @db.Text
  reviewedBy         String? // User ID who reviewed
  reviewedAt         DateTime?
  createdBy          String? // User ID who created
  assignedReviewerId String? // User ID assigned to review (set when status is PENDING_REVIEW)
  hashtags           String[]              @default([])
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  @@index([platform])
  @@index([status])
  @@index([scheduledDate])
  @@index([createdAt])
  @@index([assignedReviewerId])
}

model Coupon {
  id                          String       @id @default(cuid())
  code                        String       @unique
  description                 String?
  discountType                DiscountType @default(PERCENTAGE)
  discountValue               Decimal      @db.Decimal(10, 2)
  minPurchaseAmount           Decimal?     @db.Decimal(10, 2)
  maxDiscountAmount           Decimal?     @db.Decimal(10, 2)
  minPurchaseIncludesDelivery Boolean      @default(false) // Whether minimum purchase includes delivery cost
  usageLimit                  Int? // Total number of times coupon can be used
  usedCount                   Int          @default(0) // Number of times coupon has been used
  userUsageLimit              Int? // Limit per user (null = unlimited)
  validFrom                   DateTime     @default(now())
  validUntil                  DateTime?
  isActive                    Boolean      @default(true)
  includedProducts            String[]     @default([]) // Product IDs that are included
  excludedProducts            String[]     @default([]) // Product IDs that are excluded
  includedCategories          String[]     @default([]) // Category IDs that are included
  excludedCategories          String[]     @default([]) // Category IDs that are excluded
  source                      CouponSource @default(MANUAL) // Track if coupon was manually created or from points redemption
  createdAt                   DateTime     @default(now())
  updatedAt                   DateTime     @updatedAt

  redemption PointsRedemption?

  @@index([code])
  @@index([isActive])
  @@index([validUntil])
  @@index([createdAt])
  @@index([source])
}

model BannedEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String? // Optional reason for the ban
  bannedBy  String? // User ID of admin who banned this email
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([createdAt])
}

model Certification {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users                   User[]
  certificationCategories CertificationCategory[]

  @@index([isActive])
  @@index([name])
}

model CertificationCategory {
  id              String        @id @default(cuid())
  certificationId String
  certification   Certification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([certificationId, categoryId])
  @@index([certificationId])
  @@index([categoryId])
}

enum MegaMenuType {
  SHOP
  ABOUT
}

model MegaMenuCard {
  id        String       @id @default(cuid())
  menuType  MegaMenuType
  position  Int // 1 or 2 (first or second card)
  imageUrl  String       @db.Text
  linkUrl   String       @db.Text
  mediaType MediaType    @default(IMAGE)
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([menuType, position])
  @@index([menuType])
  @@index([isActive])
}

enum MediaType {
  IMAGE
  VIDEO
}

enum PageStatus {
  DRAFT
  PUBLISHED
  PENDING
}

model Page {
  id             String     @id @default(cuid())
  name           String
  slug           String?    @unique
  description    String?    @db.Text
  content        String?    @db.Text
  template       String     @default("Default")
  status         PageStatus @default(DRAFT)
  sections       Json? // Store page sections as JSON: { "heroSlider": { "slides": [...] }, "categoryBanner": { "categories": [...] }, ... }
  seoTitle       String?
  seoDescription String?
  seoUrl         String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([slug])
  @@index([status])
  @@index([createdAt])
}

model Affiliate {
  id                   String    @id @default(cuid())
  userId               String    @unique
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  affiliateCode        String    @unique
  isActive             Boolean   @default(true)
  approvedAt           DateTime?
  approvedBy           String? // User ID of admin who approved
  totalPointsEarned    Int       @default(0)
  currentPointsBalance Int       @default(0) // Cached balance
  totalReferrals       Int       @default(0)
  activeReferrals      Int       @default(0)
  tier                 AffiliateTier @default(BRONZE)
  tierUpdatedAt        DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  referrals AffiliateReferral[]
  linkClicks AffiliateLinkClick[]

  @@index([affiliateCode])
  @@index([isActive])
  @@index([userId])
}

model AffiliateReferral {
  id             String         @id @default(cuid())
  affiliateId    String
  affiliate      Affiliate      @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  referredUserId String         @unique // One referral per user - the user who was referred
  referredUser   User           @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)
  status         ReferralStatus @default(PENDING)
  firstOrderId   String? // When they first purchase
  referralDate   DateTime       @default(now())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  orders Order[]

  @@index([affiliateId])
  @@index([referredUserId])
  @@index([status])
  @@index([referralDate])
}

model AffiliateLinkClick {
  id          String   @id @default(cuid())
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  clickedAt   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  converted   Boolean  @default(false) // Did it lead to registration?
  convertedAt DateTime? // When did conversion happen
  convertedUserId String? // User ID if converted

  @@index([affiliateId])
  @@index([clickedAt])
  @@index([converted])
}

model PointsTransaction {
  id            String                @id @default(cuid())
  userId        String
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Int // Positive for earned, negative for spent
  type          PointsTransactionType
  referenceId   String? // orderId, referralId, redemptionId
  description   String?
  balanceBefore Int
  balanceAfter  Int
  createdAt     DateTime              @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([referenceId])
}

model Reward {
  id                String       @id @default(cuid())
  name              String
  description       String?      @db.Text
  pointsCost        Int
  discountType      DiscountType @default(PERCENTAGE)
  discountValue     Decimal      @db.Decimal(10, 2)
  minPurchaseAmount Decimal?     @db.Decimal(10, 2)
  maxDiscountAmount Decimal?     @db.Decimal(10, 2)
  isActive          Boolean      @default(true)
  stock             Int? // Optional limit on redemptions (null = unlimited)
  redeemedCount     Int          @default(0) // Track how many times redeemed
  validFrom         DateTime     @default(now())
  validUntil        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  redemptions PointsRedemption[]

  @@index([isActive])
  @@index([pointsCost])
  @@index([validUntil])
}

model PointsRedemption {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewardId    String
  reward      Reward           @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  pointsSpent Int
  couponCode  String           @unique
  couponId    String           @unique // Reference to generated Coupon
  coupon      Coupon           @relation(fields: [couponId], references: [id], onDelete: Cascade)
  status      RedemptionStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId])
  @@index([rewardId])
  @@index([status])
  @@index([createdAt])
}

model PointsConfiguration {
  id                      String                        @id @default(cuid())
  actionType              PointsConfigurationActionType
  pointsAmount            Int? // Fixed amount (null if tiered)
  tieredConfig            Json? // Tiered config: { "tiers": [{ "minOrderValue": 0, "maxOrderValue": 50, "points": 10 }, ...] }
  minOrderValue           Decimal?                      @db.Decimal(10, 2) // Optional threshold
  maxPointsPerTransaction Int? // Optional cap
  isActive                Boolean                       @default(true)
  validFrom               DateTime                      @default(now())
  validUntil              DateTime?
  createdAt               DateTime                      @default(now())
  updatedAt               DateTime                      @updatedAt

  @@index([actionType])
  @@index([isActive])
  @@index([validFrom])
  @@index([validUntil])
}

enum AdminLogActionType {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  IMPORT
  APPROVE
  REJECT
  ACTIVATE
  DEACTIVATE
  LOGIN
  LOGOUT
  BULK_OPERATION
  OTHER
}

model AdminLog {
  id           String             @id @default(cuid())
  userId       String
  user         User               @relation("AdminLogs", fields: [userId], references: [id], onDelete: Cascade)
  actionType   AdminLogActionType
  resourceType String // e.g., "Product", "Category", "User", "Order", etc.
  resourceId   String? // ID of the resource that was acted upon
  description  String // Human-readable description of the action
  details      Json? // Detailed information about the action (before/after values, changes, etc.)
  ipAddress    String?
  userAgent    String?
  metadata     Json? // Additional metadata (URL, request method, etc.)
  createdAt    DateTime           @default(now())

  @@index([userId])
  @@index([actionType])
  @@index([resourceType])
  @@index([createdAt])
  @@index([userId, createdAt])
}
